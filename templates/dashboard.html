<!DOCTYPE html>
<html lang="en" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token() }}">
    <title>Dashboard - SubTranscribe</title>

    <!-- Favicon -->
    <link rel="shortcut icon" href="/static/image/subtitle.ico">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@2.44.0/tabler-icons.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <!-- Styles -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/css/common.css">

    <script nonce="{{ g.nonce }}">
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    colors: {
                        dark: {
                            900: '#0f172a',
                            800: '#1e293b',
                            700: '#334155',
                        },
                    },
                    keyframes: {
                        shimmer: {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(100%)' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        .glass-card {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 1.5rem;
        }

        .gradient-text {
            background: linear-gradient(135deg, #38bdf8 0%, #a78bfa 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        /* Custom Scrollbar for Table */
        .custom-scrollbar::-webkit-scrollbar {
            height: 8px;
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        /* Modal Animation */
        .modal {
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease-in-out;
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            transform: scale(0.95);
            transition: all 0.3s ease-in-out;
        }

        .modal.active .modal-content {
            transform: scale(1);
        }
    </style>
</head>

<body class="bg-[#0f172a] text-white font-sans antialiased min-h-screen relative overflow-x-hidden">

    <!-- Background Image with Blur -->
    <div class="fixed inset-0 z-0 bg-cover bg-center"
        style="background-image: url('/static/image/graid_bg.png'); filter: blur(2px); opacity: 0.6;" loading="lazy">
    </div>
    <div class="fixed inset-0 z-0 bg-dark-900/40"></div>

    <!-- Navigation -->
    <nav class="fixed w-full top-0 z-50 pt-6 px-4">
        <div class="container mx-auto max-w-7xl">
            <div class="glass-card rounded-full px-6 py-3 flex items-center justify-between">
                <!-- Logo -->
                <a href="/" class="flex items-center gap-3 group">
                    <div
                        class="w-10 h-10 rounded-full bg-gradient-to-br from-blue-600 to-purple-600 flex items-center justify-center p-1.5 shadow-lg group-hover:scale-110 transition-transform duration-300">
                        <img src="/static/image/subtitle.ico" alt="SubTranscribe" class="w-full h-full object-contain">
                    </div>
                    <span
                        class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-blue-300 to-purple-300">SubTranscribe</span>
                </a>

                <!-- Right Side Actions -->
                <div class="flex items-center gap-4">
                    <a href="/"
                        class="hidden sm:block text-sm font-medium text-white/70 hover:text-white transition-colors">Home</a>
                    <a href="{{ url_for('transcribe.transcribe_page', user_id=session.get('user_id')) }}"
                        class="hidden sm:block text-sm font-medium text-white/70 hover:text-white transition-colors relative">
                        Transcribe
                        <span class="absolute -top-1 -right-2 w-2 h-2 bg-blue-500 rounded-full animate-pulse"></span>
                    </a>

                    <div class="h-4 w-px bg-white/10 mx-2 hidden sm:block"></div>

                    <a href="{{ url_for('auth.logout') }}"
                        class="flex items-center gap-2 px-4 py-2 rounded-full bg-white/10 hover:bg-white/20 border border-white/5 transition-all text-sm font-medium text-red-300 hover:text-red-200">
                        <i class="ti ti-logout"></i>
                        <span>Logout</span>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="relative z-10 pt-32 pb-20 px-4">
        <div class="container mx-auto max-w-7xl">

            <!-- Welcome Section -->
            <div class="glass-card p-8 mb-8" data-aos="fade-up">
                <div class="flex flex-col md:flex-row items-center justify-between gap-6">
                    <div class="flex items-center gap-6">
                        <div
                            class="w-16 h-16 rounded-2xl bg-gradient-to-br from-blue-500/20 to-purple-500/20 flex items-center justify-center text-3xl text-blue-400 border border-white/10">
                            <i class="ti ti-user-circle"></i>
                        </div>
                        <div>
                            <h1 class="text-3xl font-bold mb-1">Welcome back, <span class="gradient-text">{{ username
                                    }}</span></h1>
                            <p class="text-white/60">Here is an overview of your transcription activity.</p>
                        </div>
                    </div>
                    <div class="flex gap-3 w-full md:w-auto">
                        <a href="{{ url_for('setting.settings', user_id=session.get('user_id')) }}"
                            class="flex-1 md:flex-none px-6 py-3 rounded-xl bg-white/5 hover:bg-white/10 border border-white/10 transition-colors text-white font-medium text-center flex items-center justify-center gap-2">
                            <i class="ti ti-settings"></i> Settings
                        </a>
                        <a href="{{ url_for('transcribe.transcribe_page', user_id=session.get('user_id')) }}"
                            class="flex-1 md:flex-none px-6 py-3 rounded-xl bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-500 hover:to-purple-500 text-white font-bold shadow-lg shadow-blue-500/25 transition-all active:scale-95 text-center flex items-center justify-center gap-2">
                            <i class="ti ti-plus"></i> New Upload
                        </a>
                    </div>
                </div>
            </div>

            <!-- Stats Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Total Files -->
                <div class="glass-card p-6" data-aos="fade-up" data-aos-delay="100">
                    <div class="flex items-center gap-4">
                        <div class="p-3 rounded-xl bg-blue-500/10 text-blue-400 text-2xl">
                            <i class="ti ti-files"></i>
                        </div>
                        <div>
                            <p class="text-sm text-white/50 font-medium uppercase tracking-wider">Total Files</p>
                            <h3 class="text-3xl font-bold" id="total-files">0</h3>
                        </div>
                    </div>
                </div>

                <!-- Total Size -->
                <div class="glass-card p-6" data-aos="fade-up" data-aos-delay="200">
                    <div class="flex items-center gap-4">
                        <div class="p-3 rounded-xl bg-purple-500/10 text-purple-400 text-2xl">
                            <i class="ti ti-database"></i>
                        </div>
                        <div>
                            <p class="text-sm text-white/50 font-medium uppercase tracking-wider">Storage Used</p>
                            <h3 class="text-3xl font-bold" id="total-size">0 MB</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chart Section -->
            <div class="glass-card p-6 mb-8" data-aos="fade-up" data-aos-delay="300">
                <h3 class="text-lg font-bold mb-6 flex items-center gap-2">
                    <i class="ti ti-chart-bar text-blue-400"></i>
                    Activity Overview
                </h3>
                <div class="h-[300px] w-full">
                    <canvas id="userActivityChart"></canvas>
                </div>
            </div>

            <!-- Files Table -->
            <div class="glass-card p-6" data-aos="fade-up" data-aos-delay="400">
                <div class="flex flex-col md:flex-row items-center justify-between gap-4 mb-6">
                    <h3 class="text-lg font-bold flex items-center gap-2">
                        <i class="ti ti-list text-purple-400"></i>
                        Your Files
                    </h3>

                    <!-- Search -->
                    <div class="relative w-full md:w-64">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none text-white/40">
                            <i class="ti ti-search"></i>
                        </div>
                        <input type="text" id="file-search"
                            class="w-full bg-black/40 border border-white/10 rounded-xl pl-10 pr-4 py-2 text-sm text-white focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 transition-all placeholder-white/30"
                            placeholder="Search files...">
                    </div>
                </div>

                {% if files|length == 0 %}
                <div class="text-center py-12">
                    <div
                        class="w-16 h-16 rounded-full bg-white/5 mx-auto flex items-center justify-center mb-4 text-white/20 text-3xl">
                        <i class="ti ti-folder-off"></i>
                    </div>
                    <h4 class="text-lg font-medium mb-1">No files yet</h4>
                    <p class="text-white/50 mb-6 text-sm">Upload your first media file to get started.</p>
                    <a href="{{ url_for('transcribe.transcribe_page', user_id=session.get('user_id')) }}"
                        class="px-6 py-2 rounded-lg bg-blue-600 hover:bg-blue-500 text-white font-medium text-sm transition-colors">
                        Upload Now
                    </a>
                </div>
                {% else %}
                <div class="overflow-x-auto custom-scrollbar">
                    <table class="w-full text-left border-separate border-spacing-y-2">
                        <thead>
                            <tr class="text-white/40 text-xs uppercase tracking-wider">
                                <th class="px-4 pb-2 font-medium">File Name</th>
                                <th class="px-4 pb-2 font-medium">Size</th>
                                <th class="px-4 pb-2 font-medium">Date</th>
                                <th class="px-4 pb-2 font-medium text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="file-list" class="text-sm">
                            {% for file in files %}
                            <tr class="bg-white/5 hover:bg-white/10 transition-all duration-200 group relative">
                                <td class="p-4 rounded-l-xl">
                                    <div class="flex items-center gap-3">
                                        {% if file.file_name and (file.file_name.startswith('http://') or
                                        file.file_name.startswith('https://')) %}
                                        <div
                                            class="w-8 h-8 rounded-lg bg-blue-500/20 flex items-center justify-center text-blue-400">
                                            <i class="ti ti-link"></i>
                                        </div>
                                        <a href="{{ file.file_name }}" target="_blank"
                                            class="font-medium hover:text-blue-400 transition-colors truncate max-w-[200px] block file-name">{{
                                            file.file_name }}</a>
                                        {% elif file.file_name %}
                                        <div
                                            class="w-8 h-8 rounded-lg bg-emerald-500/20 flex items-center justify-center text-emerald-400">
                                            <i class="ti ti-music"></i>
                                        </div>
                                        <span class="font-medium truncate max-w-[200px] block file-name">{{
                                            file.file_name }}</span>
                                        {% else %}
                                        <div
                                            class="w-8 h-8 rounded-lg bg-red-500/20 flex items-center justify-center text-red-400">
                                            <i class="ti ti-help"></i>
                                        </div>
                                        <span class="font-medium text-white/50 file-name">Unknown</span>
                                        {% endif %}
                                    </div>
                                    <!-- Hidden ID for copy/search -->
                                    <span class="hidden transcript-id">{{ file._id }}</span>
                                </td>
                                <td class="p-4 text-white/70">
                                    {% if file.file_size %}
                                    {{ (file.file_size / (1024 * 1024))|round(2) }} MB
                                    {% else %}
                                    <span class="text-white/30">-</span>
                                    {% endif %}
                                </td>
                                <td class="p-4 text-white/70">
                                    {% if file.upload_time %}
                                    <span class="utc-time"
                                        data-timestamp="{{ file.upload_time.strftime('%Y-%m-%dT%H:%M:%S') }}Z">
                                        {{ file.upload_time.strftime('%b %d, %Y') }}
                                    </span>
                                    {% else %}
                                    <span class="text-white/30">-</span>
                                    {% endif %}
                                </td>
                                <td class="p-4 rounded-r-xl">
                                    <div
                                        class="flex items-center justify-center gap-2 opacity-100 sm:opacity-60 group-hover:opacity-100 transition-opacity">
                                        <a href="{{ url_for('subtitle.redirect_to_transcript', file_id=file._id) }}"
                                            class="p-2 rounded-lg bg-blue-500/10 hover:bg-blue-500 text-blue-400 hover:text-white transition-all"
                                            title="Download">
                                            <i class="ti ti-download"></i>
                                        </a>
                                        <button data-copy-id="{{ file._id }}"
                                            class="p-2 rounded-lg bg-white/5 hover:bg-white/20 text-white/70 hover:text-white transition-all btn-copy"
                                            title="Copy ID">
                                            <i class="ti ti-copy pointer-events-none"></i>
                                        </button>
                                        <button data-file-id="{{ file._id }}"
                                            class="p-2 rounded-lg bg-red-500/10 hover:bg-red-500 text-red-400 hover:text-white transition-all btn-delete-trigger"
                                            title="Delete">
                                            <i class="ti ti-trash pointer-events-none"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% endif %}
            </div>

        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div id="deleteModal"
        class="modal fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
        <div class="modal-content glass-card w-full max-w-md p-6 text-center relative">
            <input type="hidden" id="fileToDelete">

            <div
                class="w-16 h-16 rounded-full bg-red-500/10 flex items-center justify-center mx-auto mb-4 text-red-500 text-3xl">
                <i class="ti ti-alert-triangle"></i>
            </div>

            <h3 class="text-xl font-bold mb-2">Delete File?</h3>
            <p class="text-white/60 mb-6 text-sm">Are you sure you want to delete <span id="deleteFileName"
                    class="text-white font-medium">this file</span>? This action cannot be undone.</p>

            <div class="flex gap-3 justify-center">
                <button onclick="closeDeleteModal()"
                    class="px-5 py-2.5 rounded-xl bg-white/5 hover:bg-white/10 text-white font-medium transition-colors">
                    Cancel
                </button>
                <button id="confirmDeleteBtn"
                    class="px-5 py-2.5 rounded-xl bg-red-500 hover:bg-red-600 text-white font-bold transition-colors flex items-center gap-2">
                    <i class="ti ti-trash"></i> Delete
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="py-8 text-center text-white/30 text-sm">
        <div class="container mx-auto">
            <p>&copy; <span id="current-year"></span> SubTranscribe. All rights reserved.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <!-- Important: Move Flash Messages to bottom to mimic transcribe.html setup -->
    <!-- But this page was originally using client-side logic. 
         We'll implement a simple customized version of the Flash Message logic 
         directly here for client side events, or use the server side one if available. 
         For consistency, let's include the standardized Flash-message.html for server messages,
         AND use a JS function to trigger it for client actions. 
    -->
    {% include 'Flash-message.html' %}

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>

    <script nonce="{{ g.nonce }}">
        AOS.init();

        // 1. Chart Configuration
        document.addEventListener('DOMContentLoaded', function () {
            // Set Year
            document.getElementById('current-year').textContent = new Date().getFullYear();

            // Calculate Totals
            const fileRows = document.querySelectorAll('#file-list tr');
            const totalFilesEl = document.getElementById('total-files');
            const totalSizeEl = document.getElementById('total-size');
            let totalSize = 0;

            fileRows.forEach(row => {
                const sizeText = row.cells[1].textContent.trim();
                const size = parseFloat(sizeText); // Assumes "X.XX MB"
                if (!isNaN(size)) totalSize += size;
            });
            totalFilesEl.textContent = fileRows.length;
            totalSizeEl.textContent = totalSize.toFixed(2) + ' MB';

            // Chart
            const months = {{ months| tojson |default ('[]')
        }};
        const uploads = {{ uploads| tojson |default ('[]') }};

        if (months.length > 0 && document.getElementById('userActivityChart')) {
            const ctx = document.getElementById('userActivityChart').getContext('2d');

            // Gradient
            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(56, 189, 248, 0.5)'); // Cyan
            gradient.addColorStop(1, 'rgba(167, 139, 250, 0.0)'); // Purple transparent

            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Uploads',
                        data: uploads,
                        borderColor: '#38bdf8',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#1e293b',
                        pointBorderColor: '#38bdf8',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: 'rgba(255, 255, 255, 0.05)' },
                            ticks: { color: 'rgba(255, 255, 255, 0.4)', stepSize: 1 }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: 'rgba(255, 255, 255, 0.4)' }
                        }
                    }
                }
            });
        }

        // Format Times
        document.querySelectorAll('.utc-time').forEach(el => {
            const ts = el.getAttribute('data-timestamp');
            if (ts) {
                const d = new Date(ts);
                if (!isNaN(d)) {
                    el.textContent = d.toLocaleString(undefined, {
                        month: 'short', day: 'numeric', year: 'numeric',
                        hour: '2-digit', minute: '2-digit'
                    });
                }
            }
        });
        });

        // 2. Search Function
        document.getElementById('file-search')?.addEventListener('keyup', function () {
            const term = this.value.toLowerCase();
            const rows = document.querySelectorAll('#file-list tr');

            rows.forEach(row => {
                const name = row.querySelector('.file-name').textContent.toLowerCase();
                const id = row.querySelector('.transcript-id').textContent.toLowerCase();
                if (name.includes(term) || id.includes(term)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        // 3. Delete Modal Logic
        const deleteModal = document.getElementById('deleteModal');
        const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
        const fileToDeleteInput = document.getElementById('fileToDelete');
        const cancelDeleteBtn = document.querySelector('#deleteModal button[onclick*="closeDeleteModal"]') || document.querySelector('#deleteModal button:first-of-type');

        // Remove inline onclick from HTML first (we did it for table, but modal might still have it if we didn't edit it, 
        // but for robustness we'll select by class or structure)
        // Let's attach listeners to the table specifically using delegation

        document.getElementById('file-list').addEventListener('click', function (e) {
            const copyBtn = e.target.closest('.btn-copy');
            const deleteBtn = e.target.closest('.btn-delete-trigger');

            if (copyBtn) {
                const id = copyBtn.getAttribute('data-copy-id');
                copyToClipboard(id);
            }
            else if (deleteBtn) {
                openDeleteModal(deleteBtn);
            }
        });

        // Modal Cancel Button Listener
        // We need to find the cancel button. It was `onclick="closeDeleteModal()"`
        // Let's assume user didn't change HTML of modal yet, so we select it or add listener to it if found.
        const modalCancelBtn = document.querySelector('#deleteModal button:not(#confirmDeleteBtn)');
        if (modalCancelBtn) {
            modalCancelBtn.removeAttribute('onclick'); // Clean up just in case
            modalCancelBtn.addEventListener('click', closeDeleteModal);
        }

        function openDeleteModal(btn) {
            const id = btn.getAttribute('data-file-id');
            const row = btn.closest('tr');
            const name = row.querySelector('.file-name').textContent.trim();

            document.getElementById('deleteFileName').textContent = name;
            fileToDeleteInput.value = id;
            deleteModal.classList.add('active');
        }

        function closeDeleteModal() {
            deleteModal.classList.remove('active');
        }

        confirmDeleteBtn.addEventListener('click', function () {
            const id = fileToDeleteInput.value;
            const csrf = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            const btn = this;

            btn.disabled = true;
            btn.innerHTML = '<i class="ti ti-loader animate-spin"></i> Deleting...';

            fetch('/delete_file', {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrf
                },
                body: JSON.stringify({ file_id: id })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        // Remove row
                        // We need to find the row. Since we used delegation, we can query by data-file-id.
                        const deleteTrigger = document.querySelector(`.btn-delete-trigger[data-file-id="${id}"]`);
                        if (deleteTrigger) {
                            const row = deleteTrigger.closest('tr');
                            row.remove();
                        }

                        // Update stats
                        const totalFilesEl = document.getElementById('total-files');
                        totalFilesEl.textContent = Math.max(0, parseInt(totalFilesEl.textContent) - 1);

                        // Reload if empty to show empty state
                        if (document.querySelectorAll('#file-list tr').length === 0) location.reload();

                        closeDeleteModal();

                        // Show Notification
                        if (typeof createFlashNotification === 'function') {
                            createFlashNotification('success', 'File deleted successfully');
                        }
                    } else {
                        if (typeof createFlashNotification === 'function') {
                            createFlashNotification('error', data.message || 'Error deleting file');
                        }
                    }
                })
                .catch(err => {
                    console.error(err);
                    if (typeof createFlashNotification === 'function') {
                        createFlashNotification('error', 'Network error');
                    }
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="ti ti-trash"></i> Delete';
                });
        });

        // 4. Copy Logic
        function copyToClipboard(text) {
            if (!text) return;
            navigator.clipboard.writeText(text).then(() => {
                if (typeof createFlashNotification === 'function') {
                    createFlashNotification('success', 'Copied to clipboard!');
                }
            }).catch(() => {
                if (typeof createFlashNotification === 'function') {
                    createFlashNotification('error', 'Failed to copy');
                }
            });
        }
    </script>
</body>

</html>